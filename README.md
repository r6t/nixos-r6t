### [❄️ Flake](https://www.youtube.com/watch?v=JCeYq72Sko0) for managing personal [NixOS](https://nixos.org/) systems

### Systems

![](./nixos-r6t-flake.drawio.svg)

### Development and use

I typically generate NixOS and home-manager config in the same step, and then upgrade into the latest with:

```
nixos-rebuild switch --flake .#hostname
```

Because this is a common task, it typically runs via [`nrs`](https://github.com/r6t/nixos-r6t/blob/bddac92b6da1879f021f0b3f7875e4dd65acefe0/modules/home/fish/default.nix#L72) which takes care of flake path and hostname automatically.

### Containers

LXC Containers generated by this flake run in [Incus](https://linuxcontainers.org/incus/) on a host that is also managed by this flake. The [lxc_builder](https://github.com/r6t/nixos-r6t/blob/main/lxc_builder.py) script in this repo builds LXC images and updates Incus with them. One-off LXC image builds + Incus updates can be done via:

```
nix build .#<container name>
cp result/tarball/nixos-image-lxc-buildnumber.tar.xz root.tar.xz
nix build .#<container name>Metadata
cp result/tarball/nixos-image-lxc-buildnumber.tar.xz metadata.tar.xz
incus image import metadata.tar.xz root.tar.xz --alias <container name>
```

### Structure

```
.
├── .github                  # GitHub Actions workflow to lint code upon push to main
├── .pre-commit-config.yaml  # Nix store symlink generated upon devshell activation, target file is managed by [this flake][1]
├── containers               # LXC image definitions
├── devshells.nix            # Devshell declarations in a dedicated file to keep flake.nix tidy
├── flake.lock               # Input version control, managed by nix flake command
├── flake.nix                # Inputs (sources) and outputs (system configurations, devshells)
├── format.fish              # Shell script to format and lint project files
├── hosts                    # System/host definitions
├── modules                  # Used by host and container definitions
└── README.md                # 👋
```

[1](https://github.com/r6t/nixos-r6t/blob/6dc2d6c9bd67a276023f478f66f3c7e9ef2780a4/flake.nix#L83)

### devshell

I'm increasingly making use of [devshells](https://github.com/numtide/devshell) to manage nixpkgs that activate on-demand. Basically an OS-level virutal environment.
Devshell activation is done via a [shell function](https://github.com/r6t/nixos-r6t/blob/bddac92b6da1879f021f0b3f7875e4dd65acefe0/modules/home/fish/default.nix#L55) to allow quick devshell activation without explicitly specifying my flake path:

- Default/Nix: `nd`
- Add name argument for other devshells. Ex: `nd aws`
